<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Registrasi & Login User</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <style>
        :root {
            --primary-color: #4e54c8;
            --secondary-color: #8f94fb;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            min-height: 600px;
        }
        
        .forms-container {
            display: flex;
            min-height: 600px;
        }
        
        .form-section {
            position: absolute;
            top: 0;
            height: 100%;
            transition: all 0.6s ease-in-out;
        }
        
        .login-section {
            left: 0;
            width: 50%;
            z-index: 1;
        }
        
        .register-section {
            left: 0;
            width: 50%;
            opacity: 0;
            z-index: 0;
            overflow-y: auto; /* Tambahkan scroll */
            max-height: 600px; /* Batasi tinggi untuk memastikan scroll bekerja */
        }
        
        .container.register-mode .login-section {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .container.register-mode .register-section {
            transform: translateX(100%);
            opacity: 1;
            z-index: 5;
        }
        
        .overlay-container {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%;
            height: 100%;
            overflow: hidden;
            transition: transform 0.6s ease-in-out;
            z-index: 10;
        }
        
        .container.register-mode .overlay-container {
            transform: translateX(-100%);
        }
        
        .overlay {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            position: relative;
            left: -100%;
            height: 100%;
            width: 200%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }
        
        .container.register-mode .overlay {
            transform: translateX(50%);
        }
        
        .overlay-panel {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0 40px;
            text-align: center;
            top: 0;
            height: 100%;
            width: 50%;
            transform: translateX(0);
            transition: transform 0.6s ease-in-out;
        }
        
        .overlay-left {
            transform: translateX(-20%);
        }
        
        .container.register-mode .overlay-left {
            transform: translateX(0);
        }
        
        .overlay-right {
            right: 0;
            transform: translateX(0);
        }
        
        .container.register-mode .overlay-right {
            transform: translateX(20%);
        }
        
        h1 {
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark-color);
        }
        
        p {
            font-size: 14px;
            margin-bottom: 30px;
            line-height: 20px;
        }
        
        button {
            border-radius: 20px;
            border: 1px solid var(--primary-color);
            background-color: var(--primary-color);
            color: white;
            font-size: 14px;
            font-weight: bold;
            padding: 12px 45px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: transform 80ms ease-in;
            cursor: pointer;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button:focus {
            outline: none;
        }
        
        button.ghost {
            background-color: transparent;
            border-color: white;
        }
        
        button:disabled {
            background-color: #cccccc;
            border-color: #bbbbbb;
            color: #666666;
            cursor: not-allowed;
        }
        
        form {
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Ubah ke flex-start */
            flex-direction: column;
            padding: 20px 50px; /* Tambahkan padding atas-bawah */
            height: 100%;
            text-align: left;
            overflow-y: auto; /* Tambahkan scroll */
        }
        
        .form-group {
            width: 100%;
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: left;
            color: var(--dark-color);
        }
        
        .form-control {
            background-color: #eee;
            border: none;
            padding: 12px 15px;
            width: 100%;
            border-radius: 5px;
        }
        
        .form-control:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }
        
        .invalid-feedback {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .form-control.is-invalid {
            border: 1px solid var(--danger-color);
        }
        
        .form-control.is-invalid + .invalid-feedback {
            display: block;
        }
        
        .foto-container {
            width: 100%;
            margin: 10px 0;
            display: none;
        }
        
        #foto-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            display: block;
            margin: 0 auto 10px;
        }
        
        #canvas-container {
            position: relative;
            margin: 10px auto;
            max-width: 100%;
        }
        
        canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
        }

        .step-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .step {
            background-color: #eee;
            color: var(--dark-color);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .step.active {
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed {
            background-color: var(--success-color);
            color: white;
        }

        .registration-step {
            display: none;
            width: 100%;
        }

        .registration-step.active {
            display: block;
        }

        .camera-container {
            width: 100%;
            margin: 10px 0;
            display: none;
        }

        #video {
            width: 100%;
            max-width: 320px;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
            position: sticky; /* Buat tombol selalu terlihat */
            bottom: 0;
            background-color: white;
            padding: 10px 0;
            z-index: 5;
        }

        .verification-result {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .result-text {
            text-align: center;
            margin-bottom: 10px;
        }

        .percentage {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
        }

        .gender {
            color: var(--primary-color);
            font-weight: bold;
        }

        .registration-success {
            display: none;
            text-align: center;
            padding: 20px;
            background-color: #d4edda;
            border-radius: 5px;
            margin-top: 20px;
            color: #155724;
        }
        
        /* Tambahan untuk memastikan kontainer scrollable */
        .registration-content {
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
            padding-right: 5px; /* Untuk kompensasi scrollbar */
        }
        
        /* Untuk membuat tombol lanjutkan selalu terlihat */
        .sticky-navigation {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 10px 0;
            border-top: 1px solid #eee;
            z-index: 100;
            width: 100%;
        }

        /* Tambahkan indikator scroll */
        .scroll-indicator {
            text-align: center;
            margin-top: 10px;
            color: var(--primary-color);
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div class="forms-container">
            <div class="form-section login-section">
                <form id="login-form">
                    <h1>Login</h1>
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" class="form-control" required>
                        <div class="invalid-feedback">Username tidak valid</div>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" class="form-control" required>
                        <div class="invalid-feedback">Password tidak valid</div>
                    </div>
                    <button type="submit">Login</button>
                </form>
            </div>
            
            <div class="form-section register-section">
                <form id="register-form">
                    <h1>Registrasi</h1>
                    
                    <div id="step-form-container" class="step-container">
                        <div class="step active" id="step-1-indicator">1. Data Diri</div>
                        <div class="step" id="step-2-indicator">2. Upload Foto</div>
                        <div class="step" id="step-3-indicator">3. Verifikasi Wajah</div>
                    </div>
                    
                    <div class="registration-content" id="registration-content">
                        <div id="step-1" class="registration-step active">
                            <div class="form-group">
                                <label for="nama">Nama Lengkap</label>
                                <input type="text" id="nama" class="form-control" required pattern="[A-Za-z ]+">
                                <div class="invalid-feedback">Nama harus berupa huruf (a-z) dan spasi saja</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="username">Username</label>
                                <input type="text" id="username" class="form-control" required pattern="[a-z0-9]{3,20}">
                                <div class="invalid-feedback">Username harus berupa huruf kecil dan angka, panjang 3-20 karakter</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" id="password" class="form-control" required minlength="6" maxlength="20">
                                <div class="invalid-feedback">Password harus mengandung minimal 1 huruf kecil, 1 huruf besar, 1 angka, dan 1 karakter spesial</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="whatsapp">Nomor WhatsApp</label>
                                <input type="text" id="whatsapp" class="form-control" required pattern="62[0-9]{9,12}">
                                <div class="invalid-feedback">Nomor WhatsApp harus diawali dengan 62 dan panjang total 11-14 digit</div>
                            </div>
                        </div>
                        
                        <div id="step-2" class="registration-step">
                            <div class="form-group">
                                <label for="foto">Upload Foto Profil (JPG, 50-500 KB)</label>
                                <input type="file" id="foto" class="form-control" accept=".jpg,.jpeg">
                                <div class="invalid-feedback" id="foto-feedback">Silahkan pilih file JPG dengan ukuran 50-500 KB</div>
                            </div>
                            
                            <div class="foto-container" id="foto-container">
                                <img id="foto-preview" alt="Preview foto profil">
                                <div id="canvas-container">
                                    <canvas id="foto-canvas"></canvas>
                                </div>
                                <div id="detection-result" style="color: red; text-align: center; margin-top: 10px;"></div>
                            </div>
                            <div class="scroll-indicator" id="scroll-indicator-step2">
                                Scroll ke bawah untuk melanjutkan ↓
                            </div>
                        </div>
                        
                        <div id="step-3" class="registration-step">
                            <h2 style="text-align: center; margin-bottom: 15px;">Verifikasi Wajah dengan Kamera</h2>
                            <p style="text-align: center;">Silahkan posisikan wajah Anda di depan kamera untuk verifikasi</p>
                            
                            <div class="camera-container" id="camera-container">
                                <video id="video" autoplay muted></video>
                                <canvas id="camera-canvas" style="display: none;"></canvas>
                            </div>
                            
                            <div class="verification-result" id="verification-result">
                                <div class="result-text">
                                    Hasil Verifikasi: <span class="percentage" id="match-percentage">0%</span><br>
                                    Jenis Kelamin: <span class="gender" id="gender-result">-</span>
                                </div>
                            </div>
                            <div class="scroll-indicator" id="scroll-indicator-step3">
                                Scroll ke bawah untuk melanjutkan ↓
                            </div>
                        </div>
                    </div>
                    
                    <div class="sticky-navigation">
                        <div class="step-navigation" id="step-1-nav">
                            <button type="button" id="to-login-btn" class="ghost">Kembali ke Login</button>
                            <button type="button" id="next-to-step-2" disabled>Lanjutkan</button>
                        </div>
                        
                        <div class="step-navigation" id="step-2-nav" style="display: none;">
                            <button type="button" id="back-to-step-1">Kembali</button>
                            <button type="button" id="next-to-step-3" disabled>Lanjutkan</button>
                        </div>
                        
                        <div class="step-navigation" id="step-3-nav" style="display: none;">
                            <button type="button" id="back-to-step-2">Kembali</button>
                            <button type="submit" id="register-btn" disabled>Registrasi</button>
                        </div>
                    </div>
                    
                    <div class="registration-success" id="registration-success">
                        <h2>Registrasi Berhasil!</h2>
                        <p>Data Anda telah tersimpan. Silahkan login menggunakan username dan password yang telah dibuat.</p>
                        <button type="button" id="to-login-after-register" class="ghost">Login Sekarang</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>Selamat Datang Kembali!</h1>
                    <p>Silahkan login dengan akun yang sudah Anda miliki</p>
                    <button class="ghost" id="login-btn">Login</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>Halo, Pengguna Baru!</h1>
                    <p>Silahkan daftar untuk membuat akun Anda</p>
                    <button class="ghost" id="register-btn-start">Daftar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Deklarasi variabel global
        let model;
        let uploadedImageFace = null;
        let cameraStream = null;
        let userData = {};
        let formStepValidation = {
            step1: false,
            step2: false,
            step3: false
        };

        // Muat model BlazeFace saat halaman dimuat
        async function loadFaceDetectionModel() {
            try {
                model = await blazeface.load();
                console.log("Model wajah berhasil dimuat");
            } catch (error) {
                console.error("Error memuat model wajah:", error);
            }
        }

        // Fungsi untuk mengatur Proper Case (huruf pertama kapital)
        function toProperCase(text) {
            return text.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        // Fungsi untuk validasi nomor WhatsApp
        function formatWhatsApp(number) {
            // Hapus semua karakter non-digit
            let cleaned = number.replace(/\D/g, '');
            
            // Jika dimulai dengan 0, ganti dengan 62
            if (cleaned.startsWith('0')) {
                cleaned = '62' + cleaned.substring(1);
            }
            
            // Jika belum dimulai dengan 62, tambahkan di depan
            if (!cleaned.startsWith('62')) {
                cleaned = '62' + cleaned;
            }
            
            return cleaned;
        }

        // Fungsi untuk validasi password
        function validatePassword(password) {
            const minLength = 6;
            const maxLength = 20;
            const hasLowerCase = /[a-z]/.test(password);
            const hasUpperCase = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            return (
                password.length >= minLength &&
                password.length <= maxLength &&
                hasLowerCase &&
                hasUpperCase &&
                hasNumber &&
                hasSpecialChar
            );
        }

        // Fungsi untuk scroll ke elemen tertentu
        function scrollToElement(element, offset = 0) {
            const rect = element.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            window.scrollTo({
                top: rect.top + scrollTop - offset,
                behavior: 'smooth'
            });
            
            // Juga scroll container jika berada dalam container yang scrollable
            const container = document.getElementById('registration-content');
            if (container) {
                container.scrollTo({
                    top: container.scrollTop + rect.top - container.getBoundingClientRect().top - offset,
                    behavior: 'smooth'
                });
            }
        }

        // Fungsi untuk deteksi wajah pada foto yang diupload
        async function detectFaceInImage(imgElement) {
            try {
                const detections = await model.estimateFaces(imgElement, false);
                
                const canvas = document.getElementById('foto-canvas');
                const ctx = canvas.getContext('2d');
                
                // Atur ukuran canvas sesuai dengan gambar
                canvas.width = imgElement.width;
                canvas.height = imgElement.height;
                
                // Gambar gambar asli ke canvas
                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
                
                // Variabel untuk menyimpan hasil deteksi
                let detectionResult = document.getElementById('detection-result');
                let nextButton = document.getElementById('next-to-step-3');
                let scrollIndicator = document.getElementById('scroll-indicator-step2');
                
                if (detections.length > 0) {
                    uploadedImageFace = detections[0];
                    
                    // Atur teks hasil deteksi
                    const probability = (uploadedImageFace.probability[0] * 100).toFixed(2);
                    detectionResult.style.color = "#28a745";
                    detectionResult.textContent = `Wajah terdeteksi dengan keberhasilan ${probability}%`;
                    
                    // Gambar kotak di sekitar wajah
                    ctx.strokeStyle = "#28a745";
                    ctx.lineWidth = 3;
                    const start = uploadedImageFace.topLeft;
                    const end = uploadedImageFace.bottomRight;
                    const size = [end[0] - start[0], end[1] - start[1]];
                    ctx.strokeRect(start[0], start[1], size[0], size[1]);
                    
                    // Tambahkan teks persentase keberhasilan di atas kotak
                    ctx.fillStyle = "#28a745";
                    ctx.font = "16px Arial";
                    ctx.fillText(`${probability}%`, start[0], start[1] > 20 ? start[1] - 5 : start[1] + 20);
                    
                    // Aktifkan tombol lanjutkan
                    nextButton.disabled = false;
                    formStepValidation.step2 = true;
                    
                    // Tampilkan indikator scroll
                    scrollIndicator.style.display = 'block';
                    
                    // Scroll ke tombol lanjutkan setelah deteksi berhasil
                    setTimeout(() => {
                        scrollToElement(document.getElementById('next-to-step-3').parentElement, 20);
                    }, 500);
                } else {
                    uploadedImageFace = null;
                    detectionResult.style.color = "#dc3545";
                    detectionResult.textContent = "Wajah tidak terdeteksi! Silahkan pakai gambar JPG lainnya.";
                    nextButton.disabled = true;
                    formStepValidation.step2 = false;
                    scrollIndicator.style.display = 'none';
                }
                
                return detections.length > 0;
            } catch (error) {
                console.error("Error deteksi wajah:", error);
                return false;
            }
        }

        // Fungsi untuk menangani perubahan file foto
        function handleFotoChange(event) {
            const file = event.target.files[0];
            const imgElement = document.getElementById('foto-preview');
            const fotoContainer = document.getElementById('foto-container');
            const fotoFeedback = document.getElementById('foto-feedback');
            const fileInput = document.getElementById('foto');
            
            // Reset tampilan
            fotoContainer.style.display = 'none';
            fotoFeedback.textContent = 'Silahkan pilih file JPG dengan ukuran 50-500 KB';
            fileInput.classList.remove('is-invalid');
            document.getElementById('detection-result').textContent = '';
            document.getElementById('next-to-step-3').disabled = true;
            document.getElementById('scroll-indicator-step2').style.display = 'none';
            formStepValidation.step2 = false;
            
            if (!file) {
                return;
            }
            
            // Validasi tipe file (harus JPG/JPEG)
            if (!['image/jpeg', 'image/jpg'].includes(file.type)) {
                fotoFeedback.textContent = 'File harus berformat JPG/JPEG!';
                fileInput.classList.add('is-invalid');
                return;
            }
            
            // Validasi ukuran file (50-500 KB)
            const fileSizeKB = file.size / 1024;
            if (fileSizeKB < 50 || fileSizeKB > 500) {
                fotoFeedback.textContent = `Ukuran file (${fileSizeKB.toFixed(2)} KB) harus antara 50-500 KB!`;
                fileInput.classList.add('is-invalid');
                return;
            }
            
            // Tampilkan preview gambar
            const reader = new FileReader();
            reader.onload = function(e) {
                imgElement.src = e.target.result;
                fotoContainer.style.display = 'block';
                
                // Scroll ke gambar setelah diupload
                setTimeout(() => {
                    scrollToElement(fotoContainer, 50);
                }, 100);
                
                // Tunggu gambar benar-benar dimuat sebelum deteksi wajah
                imgElement.onload = async function() {
                    await detectFaceInImage(imgElement);
                };
            };
            reader.readAsDataURL(file);
        }

        // Fungsi untuk inisialisasi kamera
        async function initCamera() {
            const video = document.getElementById('video');
            const cameraContainer = document.getElementById('camera-container');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 320 },
                        height: { ideal: 240 },
                        facingMode: "user"
                    },
                    audio: false
                });
                
                video.srcObject = cameraStream;
                cameraContainer.style.display = 'block';
                
                // Scroll ke kamera setelah diinisialisasi
                setTimeout(() => {
                    scrollToElement(cameraContainer, 50);
                }, 100);
                
                // Mulai verifikasi wajah setelah kamera dimulai
                setTimeout(verifyFaceWithCamera, 1000);
            } catch (error) {
                console.error("Error akses kamera:", error);
                alert("Tidak dapat mengakses kamera. Silahkan izinkan akses kamera untuk verifikasi.");
            }
        }

        // Fungsi untuk menghentikan kamera
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => {
                    track.stop();
                });
                cameraStream = null;
            }
        }

        // Fungsi untuk verifikasi wajah menggunakan kamera
        async function verifyFaceWithCamera() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            const verificationResult = document.getElementById('verification-result');
            const matchPercentage = document.getElementById('match-percentage');
            const genderResult = document.getElementById('gender-result');
            const registerButton = document.getElementById('register-btn');
            const scrollIndicator = document.getElementById('scroll-indicator-step3');
            
            // Atur ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            try {
                // Gambar frame dari video ke canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Deteksi wajah pada frame
                const detections = await model.estimateFaces(video, false);
                
                if (detections.length > 0 && uploadedImageFace) {
                    const cameraFace = detections[0];
                    
                    // Hitung similarity score (contoh sederhana berdasarkan posisi)
                    // Dalam implementasi nyata, Anda perlu menggunakan algoritma face recognition yang lebih canggih
                    const similarityScore = calculateSimilarity(uploadedImageFace, cameraFace);
                    
                    // Simulasi deteksi gender (dalam implementasi nyata Anda membutuhkan model khusus untuk ini)
                    const gender = Math.random() > 0.5 ? "Laki-laki" : "Perempuan";
                    
                    // Tampilkan hasil verifikasi
                    matchPercentage.textContent = `${similarityScore.toFixed(2)}%`;
                    genderResult.textContent = gender;
                    
                    // Aktifkan tombol registrasi jika similarity score cukup tinggi
                    if (similarityScore >= 70) {
                        registerButton.disabled = false;
                        formStepValidation.step3 = true;
                        
                        // Tampilkan indikator scroll
                        scrollIndicator.style.display = 'block';
                        
                        // Scroll ke tombol registrasi
                        setTimeout(() => {
                            scrollToElement(document.getElementById('register-btn').parentElement, 20);
                        }, 500);
                    } else {
                        registerButton.disabled = true;
                        formStepValidation.step3 = false;
                        scrollIndicator.style.display = 'none';
                    }
                }
                
                // Jika kamera masih aktif, lanjutkan verifikasi
                if (cameraStream) {
                    requestAnimationFrame(verifyFaceWithCamera);
                }
            } catch (error) {
                console.error("Error verifikasi wajah:", error);
            }
        }

        // Fungsi untuk menghitung similarity antara dua wajah (simulasi)
        function calculateSimilarity(face1, face2) {
            // Ini hanya simulasi sederhana - dalam implementasi nyata, Anda perlu menggunakan
            // model face recognition yang memadai untuk mendapatkan embedding vector dan menghitung
            // cosine similarity atau jarak euclidean
            
            // Untuk demo, kita akan menggunakan normalized random dengan bias ke nilai tinggi
            // agar pengguna bisa melihat proses verifikasi berhasil
            return Math.min(100, Math.max(65, (Math.random() * 30) + 70));
        }

        // Fungsi untuk validasi form langkah 1
        function validateStep1() {
            // Ambil semua input di langkah 1
            const nama = document.getElementById('nama');
            const username = document.getElementById('username');
            const password = document.getElementById('password');
            const whatsapp = document.getElementById('whatsapp');
            
            // Reset validasi
            let isValid = true;
            
            // Validasi nama
            if (!nama.value.match(/^[A-Za-z ]+$/)) {
                nama.classList.add('is-invalid');
                isValid = false;
            } else {
                nama.classList.remove('is-invalid');
                // Konversi ke Proper Case
                nama.value = toProperCase(nama.value);
            }
            
            // Validasi username
            if (!username.value.match(/^[a-z0-9]{3,20}$/)) {
                username.classList.add('is-invalid');
                isValid = false;
            } else {
                username.classList.remove('is-invalid');
            }
            
            // Validasi password
            if (!validatePassword(password.value)) {
                password.classList.add('is-invalid');
                isValid = false;
            } else {
                password.classList.remove('is-invalid');
            }
            
            // Format dan validasi WhatsApp
            let formattedWhatsApp = formatWhatsApp(whatsapp.value);
            whatsapp.value = formattedWhatsApp;
            
            if (!formattedWhatsApp.match(/^62[0-9]{9,12}$/)) {
                whatsapp.classList.add('is-invalid');
                isValid = false;
            } else {
                whatsapp.classList.remove('is-invalid');
            }
            
            // Update status validasi
            formStepValidation.step1 = isValid;
            
            // Update tombol lanjutkan
            document.getElementById('next-to-step-2').disabled = !isValid;
            
            return isValid;
        }

        // Fungsi untuk pindah langkah
        function goToStep(step) {
            // Sembunyikan semua langkah
            document.querySelectorAll('.registration-step').forEach(el => {
                el.classList.remove('active');
            });
            
            // Sembunyikan semua navigasi
            document.querySelectorAll('.step-navigation').forEach(el => {
                el.style.display = 'none';
            });
            
            // Reset indikator langkah
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active', 'completed');
            });
            
            // Aktifkan langkah yang dipilih
            document.getElementById(`step-${step}`).classList.add('active');
            document.getElementById(`step-${step}-nav`).style.display = 'flex';
            
            // Atur indikator langkah
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                
                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }
            
            // Scroll ke atas form
            scrollToElement(document.getElementById(`step-${step}`), 100);
            
            // Jika pindah ke langkah 3, inisialisasi kamera
            if (step === 3) {
                initCamera();
            } else {
                // Hentikan kamera jika pindah dari langkah 3
                stopCamera();
            }
        }

        // Event listener saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            // Muat model deteksi wajah
            loadFaceDetectionModel();
            
            // Toggle antara form login dan register
            const loginButton = document.getElementById('login-btn');
            const registerButton = document.getElementById('register-btn-start');
            const container = document.getElementById('container');
            
            loginButton.addEventListener('click', () => {
                container.classList.remove('register-mode');
                stopCamera(); // Pastikan kamera berhenti jika kembali ke login
            });
            
            registerButton.addEventListener('click', () => {
                container.classList.add('register-mode');
                // Reset form registrasi saat dibuka
                document.getElementById('register-form').reset();
                goToStep(1);
            });
            
            // Handler tombol kembali ke login dari langkah 1
            document.getElementById('to-login-btn').addEventListener('click', () => {
                container.classList.remove('register-mode');
            });
            
            // Handler input langkah 1
            document.querySelectorAll('#step-1 input').forEach(input => {
                input.addEventListener('input', () => {
                    validateStep1();
                });
                
                input.addEventListener('blur', () => {
                    validateStep1();
                });
            });
            
            // Handler tombol langkah 1 ke langkah 2
            document.getElementById('next-to-step-2').addEventListener('click', () => {
                if (validateStep1()) {
                    // Simpan data langkah 1
                    userData.nama = document.getElementById('nama').value;
                    userData.username = document.getElementById('username').value;
                    userData.password = document.getElementById('password').value;
                    userData.whatsapp = document.getElementById('whatsapp').value;
                    
                    goToStep(2);
                }
            });
            
            // Handler tombol langkah 2 kembali ke langkah 1
            document.getElementById('back-to-step-1').addEventListener('click', () => {
                goToStep(1);
            });
            
            // Handler perubahan file foto
            document.getElementById('foto').addEventListener('change', handleFotoChange);
            
            // Handler tombol langkah 2 ke langkah 3
            document.getElementById('next-to-step-3').addEventListener('click', () => {
                if (formStepValidation.step2) {
                    goToStep(3);
                }
            });
            
            // Handler tombol langkah 3 kembali ke langkah 2
            document.getElementById('back-to-step-2').addEventListener('click', () => {
                goToStep(2);
            });
            
            // Handler form registrasi
            document.getElementById('register-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                if (formStepValidation.step1 && formStepValidation.step2 && formStepValidation.step3) {
                    // Simpan data verifikasi
                    userData.matchPercentage = document.getElementById('match-percentage').textContent;
                    userData.gender = document.getElementById('gender-result').textContent;
                    userData.registrationDate = new Date().toISOString();
                    
                    // Simulasi penyimpanan data (dalam implementasi nyata, kirim ke server)
                    console.log("Data registrasi:", userData);
                    
                    // Simpan ke localStorage untuk demo
                    const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
                    users.push(userData);
                    localStorage.setItem('registered_users', JSON.stringify(users));
                    
                    // Tampilkan pesan sukses
                    document.getElementById('step-3').style.display = 'none';
                    document.getElementById('step-3-nav').style.display = 'none';
                    document.getElementById('registration-success').style.display = 'block';
                    
                    // Hentikan kamera
                    stopCamera();
                }
            });
            
            // Handler tombol login setelah registrasi
            document.getElementById('to-login-after-register').addEventListener('click', () => {
                container.classList.remove('register-mode');
                
                // Isi otomatis form login
                document.getElementById('login-username').value = userData.username;
                document.getElementById('login-password').value = userData.password;
            });
            
            // Handler form login
            document.getElementById('login-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                // Cek data di localStorage untuk demo
                const users = JSON.parse(localStorage.getItem('registered_users') || '[]');
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    alert(`Selamat datang, ${user.nama}! Login berhasil.`);
                    // Redirect ke dashboard atau halaman utama (untuk demo)
                    // window.location.href = 'dashboard.html';
                } else {
                    alert('Username atau password salah!');
                }
            });
        });
    </script>
</body>
</html>